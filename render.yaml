# ═══════════════════════════════════════════════════════════════
# ROM AGENT - CONFIGURAÇÃO RENDER.COM
# ═══════════════════════════════════════════════════════════════
# Serviço Web Principal - Interface Claude AI + API Bedrock
# Deploy automático via GitHub (main branch)
# ═══════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════
  # PRODUÇÃO - Branch main
  # ═══════════════════════════════════════════════════════════════
  - type: web
    name: rom-agent
    runtime: node
    plan: free
    branch: main

    # ═══ BUILD ═══
    buildCommand: bash scripts/build-production.sh

    # ═══ START ═══
    # CRÍTICO: Iniciar servidor IMEDIATAMENTE para evitar port scan timeout
    # Frontend já foi buildado no buildCommand
    # Migrations rodam assíncronamente após servidor abrir porta
    startCommand: npm run web:enhanced

    # ═══ VARIÁVEIS DE AMBIENTE ═══
    envVars:
      # Node.js
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: 25.2.1

      # Porta (Render usa 10000)
      - key: PORT
        value: 10000

      # ✅ FORÇAR USO DO DISCO PERSISTENTE /var/data
      - key: RENDER
        value: "true"
      - key: UPLOAD_FOLDER
        value: /var/data/upload
      - key: EXTRACTED_FOLDER
        value: /var/data/extracted
      - key: PROCESSED_FOLDER
        value: /var/data/processed

      # AWS Bedrock (obrigatório)
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_REGION
        value: us-west-2

      # Anthropic (alternativo)
      - key: ANTHROPIC_API_KEY
        sync: false

      # DataJud (consulta jurisprudência)
      - key: DATAJUD_API_KEY
        sync: false

      # ═══════════════════════════════════════════════════════════════
      # GOOGLE CUSTOM SEARCH API - CRÍTICO PARA JURISPRUDÊNCIA
      # ═══════════════════════════════════════════════════════════════
      # SEM ISSO: Busca trava 30+ segundos e falha
      # COM ISSO: Busca retorna em 300ms-2s com resultados reais
      # ═══════════════════════════════════════════════════════════════
      - key: GOOGLE_SEARCH_API_KEY
        sync: false
      - key: GOOGLE_SEARCH_CX
        sync: false

      # Session Secret (auto-gerado)
      - key: SESSION_SECRET
        generateValue: true

      # PostgreSQL Database (Internal Database URL)
      - key: DATABASE_URL
        value: postgresql://rom_agent_user:faPSk0YSNlhyPfBYpri2RcK9XdRbaE8L@dpg-d5819bhr0fns73dmfsv0-a/rom_agent

      # Rate Limiter
      - key: RATE_LIMIT_PER_MINUTE
        value: 10
      - key: RATE_LIMIT_PER_HOUR
        value: 100

    # ═══ HEALTH CHECK ═══
    healthCheckPath: /api/info

    # ═══ RECURSOS ═══
    # Disco persistente (criado automaticamente no primeiro deploy)
    disk:
      mountPath: /var/data
      sizeGB: 1

    # ═══ AUTO-DEPLOY ═══
    autoDeploy: true

    # ═══ DOMÍNIOS ═══
    domains:
      - iarom.com.br
      - www.iarom.com.br

  # ═══════════════════════════════════════════════════════════════
  # STAGING - Branch staging
  # ═══════════════════════════════════════════════════════════════
  - type: web
    name: rom-agent-staging
    runtime: node
    plan: free
    branch: staging

    # ═══ BUILD ═══
    buildCommand: bash scripts/build-production.sh

    # ═══ START ═══
    # CRÍTICO: Iniciar servidor IMEDIATAMENTE para evitar port scan timeout
    # Frontend já foi buildado no buildCommand
    # Migrations rodam assíncronamente após servidor abrir porta
    startCommand: npm run web:enhanced

    # ═══ VARIÁVEIS DE AMBIENTE ═══
    envVars:
      # Node.js
      - key: NODE_ENV
        value: staging
      - key: NODE_VERSION
        value: 25.2.1

      # Porta (Render usa 10000)
      - key: PORT
        value: 10000

      # ✅ FORÇAR USO DO DISCO PERSISTENTE /var/data
      - key: RENDER
        value: "true"
      - key: UPLOAD_FOLDER
        value: /var/data/upload
      - key: EXTRACTED_FOLDER
        value: /var/data/extracted
      - key: PROCESSED_FOLDER
        value: /var/data/processed

      # AWS Bedrock (obrigatório)
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_REGION
        value: us-west-2

      # Anthropic (alternativo)
      - key: ANTHROPIC_API_KEY
        sync: false

      # DataJud (consulta jurisprudência)
      - key: DATAJUD_API_KEY
        sync: false

      # ═══════════════════════════════════════════════════════════════
      # GOOGLE CUSTOM SEARCH API - CRÍTICO PARA JURISPRUDÊNCIA
      # ═══════════════════════════════════════════════════════════════
      # SEM ISSO: Busca trava 30+ segundos e falha
      # COM ISSO: Busca retorna em 300ms-2s com resultados reais
      # ═══════════════════════════════════════════════════════════════
      - key: GOOGLE_SEARCH_API_KEY
        sync: false
      - key: GOOGLE_SEARCH_CX
        sync: false

      # Session Secret (auto-gerado)
      - key: SESSION_SECRET
        generateValue: true

      # PostgreSQL Database (Internal Database URL)
      - key: DATABASE_URL
        value: postgresql://rom_agent_user:faPSk0YSNlhyPfBYpri2RcK9XdRbaE8L@dpg-d5819bhr0fns73dmfsv0-a/rom_agent

      # Database Schema (staging usa schema separado)
      - key: DATABASE_SCHEMA
        value: staging

      # Rate Limiter (mais permissivo para testes)
      - key: RATE_LIMIT_PER_MINUTE
        value: 20
      - key: RATE_LIMIT_PER_HOUR
        value: 200

    # ═══ HEALTH CHECK ═══
    healthCheckPath: /api/info

    # ═══ RECURSOS ═══
    # Disco persistente separado para staging
    disk:
      mountPath: /var/data
      sizeGB: 1

    # ═══ AUTO-DEPLOY ═══
    autoDeploy: true
