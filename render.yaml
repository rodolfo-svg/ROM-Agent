# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ROM AGENT - CONFIGURAÃ‡ÃƒO RENDER.COM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ServiÃ§o Web Principal - Interface Claude AI + API Bedrock
# Deploy automÃ¡tico via GitHub (main branch)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

services:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PRODUÃ‡ÃƒO - Branch main
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: web
    name: rom-agent
    runtime: node
    plan: free
    branch: main

    # â•â•â• BUILD â•â•â•
    buildCommand: |
      echo "ğŸ”§ Instalando todas as dependÃªncias (sem --only=production)..."
      npm ci
      echo "ğŸ§¹ Limpando build anterior do frontend..."
      rm -rf frontend/dist
      echo "ğŸ—ï¸ Buildando frontend React..."
      cd frontend && npm ci && npm run build && cd ..
      echo "ğŸ“¦ Verificando arquivos gerados..."
      if [ ! -d "frontend/dist" ]; then
        echo "âŒ ERRO CRÃTICO: frontend/dist nÃ£o foi criado!"
        exit 1
      fi
      if [ ! -f "frontend/dist/index.html" ]; then
        echo "âŒ ERRO CRÃTICO: frontend/dist/index.html nÃ£o existe!"
        exit 1
      fi
      echo "âœ… Build do frontend verificado com sucesso!"
      ls -lah frontend/dist/ | head -20
      echo "ğŸ—„ï¸ Executando migrations do banco de dados..."
      npm run db:migrate || echo "âš ï¸ Migrations falharam (pode ser normal se jÃ¡ aplicadas)"
      echo "âœ… Build completo!"

    # â•â•â• START â•â•â•
    startCommand: npm run db:migrate && node scripts/ensure-frontend-build.js && npm run web:enhanced

    # â•â•â• VARIÃVEIS DE AMBIENTE â•â•â•
    envVars:
      # Node.js
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: 25.2.1

      # Porta (Render usa 10000)
      - key: PORT
        value: 10000

      # âœ… FORÃ‡AR USO DO DISCO PERSISTENTE /var/data
      - key: RENDER
        value: "true"
      - key: UPLOAD_FOLDER
        value: /var/data/upload
      - key: EXTRACTED_FOLDER
        value: /var/data/extracted
      - key: PROCESSED_FOLDER
        value: /var/data/processed

      # AWS Bedrock (obrigatÃ³rio)
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_REGION
        value: us-west-2

      # Anthropic (alternativo)
      - key: ANTHROPIC_API_KEY
        sync: false

      # DataJud (consulta jurisprudÃªncia)
      - key: DATAJUD_API_KEY
        sync: false

      # Session Secret (auto-gerado)
      - key: SESSION_SECRET
        generateValue: true

      # PostgreSQL Database (Internal Database URL)
      - key: DATABASE_URL
        value: postgresql://rom_agent_user:faPSk0YSNlhyPfBYpri2RcK9XdRbaE8L@dpg-d5819bhr0fns73dmfsv0-a/rom_agent

      # Rate Limiter
      - key: RATE_LIMIT_PER_MINUTE
        value: 10
      - key: RATE_LIMIT_PER_HOUR
        value: 100

    # â•â•â• HEALTH CHECK â•â•â•
    healthCheckPath: /api/info

    # â•â•â• RECURSOS â•â•â•
    # Disco persistente (criado automaticamente no primeiro deploy)
    disk:
      mountPath: /var/data
      sizeGB: 1

    # â•â•â• AUTO-DEPLOY â•â•â•
    autoDeploy: true

    # â•â•â• DOMÃNIOS â•â•â•
    domains:
      - iarom.com.br
      - www.iarom.com.br

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGING - Branch staging
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: web
    name: rom-agent-staging
    runtime: node
    plan: free
    branch: staging

    # â•â•â• BUILD â•â•â•
    buildCommand: |
      echo "ğŸ”§ Instalando todas as dependÃªncias (sem --only=production)..."
      npm ci
      echo "ğŸ§¹ Limpando build anterior do frontend..."
      rm -rf frontend/dist
      echo "ğŸ—ï¸ Buildando frontend React..."
      cd frontend && npm ci && npm run build && cd ..
      echo "ğŸ“¦ Verificando arquivos gerados..."
      if [ ! -d "frontend/dist" ]; then
        echo "âŒ ERRO CRÃTICO: frontend/dist nÃ£o foi criado!"
        exit 1
      fi
      if [ ! -f "frontend/dist/index.html" ]; then
        echo "âŒ ERRO CRÃTICO: frontend/dist/index.html nÃ£o existe!"
        exit 1
      fi
      echo "âœ… Build do frontend verificado com sucesso!"
      ls -lah frontend/dist/ | head -20
      echo "ğŸ—„ï¸ Executando migrations do banco de dados..."
      npm run db:migrate || echo "âš ï¸ Migrations falharam (pode ser normal se jÃ¡ aplicadas)"
      echo "âœ… Build completo!"

    # â•â•â• START â•â•â•
    startCommand: npm run db:migrate && node scripts/ensure-frontend-build.js && npm run web:enhanced

    # â•â•â• VARIÃVEIS DE AMBIENTE â•â•â•
    envVars:
      # Node.js
      - key: NODE_ENV
        value: staging
      - key: NODE_VERSION
        value: 25.2.1

      # Porta (Render usa 10000)
      - key: PORT
        value: 10000

      # âœ… FORÃ‡AR USO DO DISCO PERSISTENTE /var/data
      - key: RENDER
        value: "true"
      - key: UPLOAD_FOLDER
        value: /var/data/upload
      - key: EXTRACTED_FOLDER
        value: /var/data/extracted
      - key: PROCESSED_FOLDER
        value: /var/data/processed

      # AWS Bedrock (obrigatÃ³rio)
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_REGION
        value: us-west-2

      # Anthropic (alternativo)
      - key: ANTHROPIC_API_KEY
        sync: false

      # DataJud (consulta jurisprudÃªncia)
      - key: DATAJUD_API_KEY
        sync: false

      # Session Secret (auto-gerado)
      - key: SESSION_SECRET
        generateValue: true

      # PostgreSQL Database (Internal Database URL)
      - key: DATABASE_URL
        value: postgresql://rom_agent_user:faPSk0YSNlhyPfBYpri2RcK9XdRbaE8L@dpg-d5819bhr0fns73dmfsv0-a/rom_agent

      # Database Schema (staging usa schema separado)
      - key: DATABASE_SCHEMA
        value: staging

      # Rate Limiter (mais permissivo para testes)
      - key: RATE_LIMIT_PER_MINUTE
        value: 20
      - key: RATE_LIMIT_PER_HOUR
        value: 200

    # â•â•â• HEALTH CHECK â•â•â•
    healthCheckPath: /api/info

    # â•â•â• RECURSOS â•â•â•
    # Disco persistente separado para staging
    disk:
      mountPath: /var/data
      sizeGB: 1

    # â•â•â• AUTO-DEPLOY â•â•â•
    autoDeploy: true
