import{j as n}from"./ui-DIb4OZiY.js";import{e as F,a as i}from"./vendor-Dc3V-jfM.js";import{u as g,S as $}from"./Sidebar-B9p3iIsM.js";import{u as G,E as L,M as O,C as U,A as V,c as q}from"./api-gAnyUOXd.js";import"./index-DrS4hEe-.js";function W(){const{conversationId:f}=F(),E=i.useRef(null),m=i.useRef(null),{conversations:u,activeConversationId:l,loadConversations:b,createConversation:y,selectConversation:x,addMessage:I,updateMessage:v,isStreaming:A,setStreaming:p,selectedModel:j}=g(),{artifacts:R,addArtifact:N}=G(),o=u.find(s=>s.id===l),k=()=>{var s;(s=E.current)==null||s.scrollIntoView({behavior:"smooth"})};i.useEffect(()=>{k()},[o==null?void 0:o.messages]),i.useEffect(()=>{b()},[]),i.useEffect(()=>{f&&f!==l&&x(f)},[f]),i.useEffect(()=>{const c=g.getState().conversations.find(a=>a.id===l);l&&c&&c.messages.length===0&&(console.log("ðŸ“Œ useEffect: Carregando mensagens para conversa ativa:",l),x(l))},[l,u.length]),i.useEffect(()=>{!o&&u.length===0&&y()},[u.length]);const P=s=>R.filter(c=>c.messageId===s),S=async(s,c)=>{var M,C;let a=l;a||(a=(await y()).id);let r=g.getState(),t=r.conversations.find(e=>e.id===a);t&&t.messages.length===0&&(console.log("â³ Mensagens nÃ£o carregadas, carregando do backend..."),await x(a),r=g.getState(),t=r.conversations.find(e=>e.id===a),console.log("âœ… Mensagens carregadas:",((M=t==null?void 0:t.messages)==null?void 0:M.length)||0)),console.log("ðŸ” FRONTEND DEBUG:"),console.log("   convId:",a),console.log("   conversation found:",!!t),console.log("   conversation.messages length:",((C=t==null?void 0:t.messages)==null?void 0:C.length)||0),console.log("   conversation.messages:",t==null?void 0:t.messages),console.log("   conversations array length:",r.conversations.length),console.log("   activeConversationId from state:",r.activeConversationId);const w=(t==null?void 0:t.messages.filter(e=>e.content&&e.content.trim()!=="").map(e=>({role:e.role,content:e.content})))||[];console.log("   conversationMessages to send:",w.length),console.log(""),I({role:"user",content:s});const d=I({role:"assistant",content:"",isStreaming:!0,model:j});p(!0);let h="";try{m.current=new AbortController;for await(const e of q(s,{conversationId:a,model:j,messages:w,signal:m.current.signal}))if(e.type==="chunk"&&e.content)h+=e.content,v(d.id,h);else if(e.type==="artifact"&&e.artifact){const D=N({title:e.artifact.title,type:e.artifact.type,content:e.artifact.content,language:e.artifact.language,messageId:d.id});g.getState().addArtifactToMessage(d.id,D.id)}else e.type==="error"&&(h=`âŒ ${e.error}`,v(d.id,h))}catch(e){e.name!=="AbortError"&&v(d.id,`âŒ Erro: ${e.message}`)}finally{p(!1),m.current=null}},T=()=>{var s;(s=m.current)==null||s.abort(),p(!1)},B=async s=>{const c=(o==null?void 0:o.messages)||[],a=c.findIndex(r=>r.id===s);if(a>0){const r=c[a-1];r.role==="user"&&await S(r.content)}};return n.jsxs("div",{className:"h-screen flex bg-stone-50 overflow-hidden",children:[n.jsx($,{}),n.jsxs("div",{className:"flex-1 flex flex-col min-w-0 max-md:w-full",children:[n.jsx("div",{className:"flex-1 overflow-y-auto overscroll-contain webkit-overflow-scrolling-touch pb-safe",children:!o||o.messages.length===0?n.jsx(L,{onSuggestionClick:S}):n.jsxs("div",{className:"max-w-3xl mx-auto px-4 py-6 max-md:px-3 max-md:py-4",children:[o.messages.map((s,c)=>n.jsx(O,{message:s,artifacts:P(s.id),onRegenerate:s.role==="assistant"&&!s.isStreaming?()=>B(s.id):void 0},s.id)),n.jsx("div",{ref:E})]})}),n.jsx("div",{className:"flex-shrink-0 pb-safe",children:n.jsx(U,{onSend:S,isLoading:A,onStop:T})})]}),n.jsx(V,{})]})}export{W as ChatPage};
