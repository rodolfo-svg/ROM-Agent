<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Pipeline | ROM Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stages-selector {
            display: none;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .stages-selector.active {
            display: block;
        }

        .stage-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .stage-checkbox input {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
        }

        .stage-checkbox label {
            margin: 0;
            cursor: pointer;
        }

        .stage-info {
            font-size: 0.875rem;
            color: #666;
            margin-left: 2rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            width: auto;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .pipeline-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .pipeline-item {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .pipeline-item.executando {
            border-left-color: #ffa500;
        }

        .pipeline-item.concluido {
            border-left-color: #38ef7d;
        }

        .pipeline-item.erro {
            border-left-color: #eb3349;
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .pipeline-id {
            font-weight: 600;
            color: #333;
            font-size: 0.875rem;
        }

        .pipeline-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pipeline-status.criado {
            background: #e3f2fd;
            color: #1976d2;
        }

        .pipeline-status.executando {
            background: #fff3e0;
            color: #f57c00;
        }

        .pipeline-status.concluido {
            background: #e8f5e9;
            color: #388e3c;
        }

        .pipeline-status.erro {
            background: #ffebee;
            color: #d32f2f;
        }

        .pipeline-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #666;
        }

        .pipeline-progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .pipeline-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .pipeline-stages {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .stage-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            background: #667eea;
            color: white;
        }

        .pipeline-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cost-estimate {
            background: #fff9c4;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid #ffa000;
        }

        .cost-estimate strong {
            color: #e65100;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #4caf50;
        }

        .alert-error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #f44336;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Multi-Agent Pipeline</h1>
            <p>Sistema de an√°lise de processos grandes (6700+ p√°ginas) com m√∫ltiplos modelos de IA</p>
        </div>

        <div class="content">
            <!-- Formul√°rio de Cria√ß√£o -->
            <div class="card">
                <h2>üìã Criar Novo Pipeline</h2>

                <form id="createPipelineForm">
                    <div class="form-group">
                        <label for="documentPath">Caminho do Documento *</label>
                        <input type="text" id="documentPath" name="documentPath"
                               placeholder="/caminho/para/processo-6700-paginas.txt" required>
                    </div>

                    <div class="form-group">
                        <label for="mode">Modo de Execu√ß√£o *</label>
                        <select id="mode" name="mode" required>
                            <option value="automatico">üöÄ Autom√°tico - Execu√ß√£o completa sem interven√ß√£o</option>
                            <option value="manual">‚úã Manual - Revisar cada stage antes de prosseguir</option>
                            <option value="hibrido">‚öôÔ∏è H√≠brido - Pontos de aprova√ß√£o estrat√©gicos</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="budget">Or√ßamento *</label>
                        <select id="budget" name="budget" required>
                            <option value="economico">üí∞ Econ√¥mico (~$3.45) - M√°ximo custo-benef√≠cio</option>
                            <option value="premium">üíé Premium (~$5.95) - M√°xima qualidade</option>
                            <option value="flexivel">üéõÔ∏è Flex√≠vel - Escolher stages manualmente</option>
                        </select>
                    </div>

                    <!-- Seletor de Stages (aparece apenas em modo flex√≠vel) -->
                    <div id="stagesSelector" class="stages-selector">
                        <strong>Selecione os Stages:</strong>
                        <div style="margin-top: 1rem;">
                            <div class="stage-checkbox">
                                <input type="checkbox" id="stage_leitura_massiva" value="leitura_massiva">
                                <label for="stage_leitura_massiva">üìö Leitura Massiva</label>
                            </div>
                            <div class="stage-info">Llama 3.3 70B - Processamento de grandes volumes (~$1.05)</div>

                            <div class="stage-checkbox">
                                <input type="checkbox" id="stage_analise_profunda" value="analise_profunda">
                                <label for="stage_analise_profunda">üéØ An√°lise Profunda</label>
                            </div>
                            <div class="stage-info">Claude Sonnet 4.5 - An√°lise jur√≠dica detalhada (~$0.80)</div>

                            <div class="stage-checkbox">
                                <input type="checkbox" id="stage_fundamentacao" value="fundamentacao">
                                <label for="stage_fundamentacao">üß† Fundamenta√ß√£o Legal</label>
                            </div>
                            <div class="stage-info">DeepSeek R1 - Racioc√≠nio jur√≠dico exposto (~$0.40)</div>

                            <div class="stage-checkbox">
                                <input type="checkbox" id="stage_redacao" value="redacao">
                                <label for="stage_redacao">‚úçÔ∏è Reda√ß√£o Final</label>
                            </div>
                            <div class="stage-info">Claude Sonnet 4.5 - Escrita jur√≠dica premium (~$1.20)</div>

                            <div class="stage-checkbox">
                                <input type="checkbox" id="stage_validacao" value="validacao">
                                <label for="stage_validacao">üíé Valida√ß√£o Premium</label>
                            </div>
                            <div class="stage-info">Claude Opus 4.5 - Revis√£o de m√°xima qualidade (~$2.50)</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="outputType">Tipo de Sa√≠da</label>
                        <select id="outputType" name="outputType">
                            <option value="revisao_criminal">üìù Revis√£o Criminal</option>
                            <option value="embargos">‚öñÔ∏è Embargos de Declara√ß√£o</option>
                            <option value="recurso">üìÑ Recurso</option>
                            <option value="peticao">üìã Peti√ß√£o</option>
                            <option value="parecer">üîç Parecer T√©cnico</option>
                        </select>
                    </div>

                    <div id="costEstimate" class="cost-estimate" style="display: none;">
                        <strong>üí∞ Custo Estimado:</strong> <span id="estimatedCost">$0.00</span>
                    </div>

                    <button type="submit" class="btn">üöÄ Criar Pipeline</button>
                </form>

                <div id="createAlert" style="margin-top: 1rem;"></div>
            </div>

            <!-- Lista de Pipelines -->
            <div class="card">
                <h2>üìä Pipelines Criados</h2>

                <div id="pipelinesList">
                    <div class="loading">
                        <p>Carregando pipelines...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Controle do seletor de stages
        const budgetSelect = document.getElementById('budget');
        const stagesSelector = document.getElementById('stagesSelector');

        budgetSelect.addEventListener('change', () => {
            if (budgetSelect.value === 'flexivel') {
                stagesSelector.classList.add('active');
            } else {
                stagesSelector.classList.remove('active');
            }
        });

        // Criar Pipeline
        document.getElementById('createPipelineForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                documentPath: formData.get('documentPath'),
                mode: formData.get('mode'),
                budget: formData.get('budget'),
                outputType: formData.get('outputType')
            };

            // Se modo flex√≠vel, coletar stages selecionados
            if (data.budget === 'flexivel') {
                const selectedStages = [];
                document.querySelectorAll('#stagesSelector input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedStages.push(checkbox.value);
                });

                if (selectedStages.length === 0) {
                    showAlert('createAlert', 'Selecione ao menos um stage no modo flex√≠vel', 'error');
                    return;
                }

                data.selectedStages = selectedStages;
            }

            try {
                const response = await fetch('/api/multi-agent/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('createAlert', `Pipeline criado com sucesso! ID: ${result.pipeline.id}`, 'success');
                    e.target.reset();
                    loadPipelines();
                } else {
                    showAlert('createAlert', `Erro: ${result.error}`, 'error');
                }
            } catch (error) {
                showAlert('createAlert', `Erro ao criar pipeline: ${error.message}`, 'error');
            }
        });

        // Carregar lista de pipelines
        async function loadPipelines() {
            const container = document.getElementById('pipelinesList');
            container.innerHTML = '<div class="loading"><p>Carregando...</p></div>';

            try {
                const response = await fetch('/api/multi-agent/list');
                const result = await response.json();

                if (result.success && result.pipelines.length > 0) {
                    container.innerHTML = result.pipelines
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                        .map(pipeline => renderPipeline(pipeline))
                        .join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p>Nenhum pipeline criado ainda</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Erro ao carregar pipelines: ${error.message}</div>`;
            }
        }

        // Renderizar pipeline
        function renderPipeline(pipeline) {
            const statusClass = pipeline.status;
            const createdDate = new Date(pipeline.createdAt).toLocaleString('pt-BR');

            return `
                <div class="pipeline-item ${statusClass}" data-id="${pipeline.id}">
                    <div class="pipeline-header">
                        <div class="pipeline-id">üÜî ${pipeline.id}</div>
                        <div class="pipeline-status ${statusClass}">${getStatusText(pipeline.status)}</div>
                    </div>

                    <div class="pipeline-info">
                        <div>üìÖ Criado: ${createdDate}</div>
                        <div>‚öôÔ∏è Modo: ${getModeText(pipeline.config.mode)}</div>
                        <div>üí∞ Or√ßamento: ${getBudgetText(pipeline.config.budget)}</div>
                        <div>üìä Progresso: ${pipeline.progress}%</div>
                    </div>

                    ${pipeline.status === 'executando' ? `
                        <div class="pipeline-progress">
                            <div class="pipeline-progress-bar" style="width: ${pipeline.progress}%"></div>
                        </div>
                    ` : ''}

                    <div class="pipeline-actions">
                        ${pipeline.status === 'criado' ? `
                            <button class="btn btn-small btn-success" onclick="executePipeline('${pipeline.id}')">
                                ‚ñ∂Ô∏è Executar
                            </button>
                        ` : ''}
                        <button class="btn btn-small" onclick="viewPipelineStatus('${pipeline.id}')">
                            üëÅÔ∏è Ver Status
                        </button>
                    </div>
                </div>
            `;
        }

        // Executar pipeline
        async function executePipeline(pipelineId) {
            if (!confirm(`Deseja executar o pipeline ${pipelineId}?\n\nEsta opera√ß√£o pode levar v√°rios minutos e consumir cr√©ditos da API.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/multi-agent/execute/${pipelineId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Pipeline ${pipelineId} iniciado com sucesso!\n\nUse "Ver Status" para acompanhar o progresso.`);
                    loadPipelines();
                    // Iniciar polling de status
                    startStatusPolling(pipelineId);
                } else {
                    alert(`Erro: ${result.error}`);
                }
            } catch (error) {
                alert(`Erro ao executar pipeline: ${error.message}`);
            }
        }

        // Ver status do pipeline
        async function viewPipelineStatus(pipelineId) {
            try {
                const response = await fetch(`/api/multi-agent/status/${pipelineId}`);
                const result = await response.json();

                if (result.success) {
                    const pipeline = result.pipeline;
                    let message = `Pipeline: ${pipeline.id}\n`;
                    message += `Status: ${getStatusText(pipeline.status)}\n`;
                    message += `Progresso: ${pipeline.progress}%\n`;
                    message += `Custo Estimado: $${pipeline.estimatedCost.toFixed(2)}\n`;
                    message += `\nStages (${pipeline.stages.length}):\n`;
                    pipeline.stages.forEach((stage, i) => {
                        const icon = getStageIcon(stage);
                        message += `  ${i + 1}. ${icon} ${stage}\n`;
                    });

                    if (pipeline.currentStage) {
                        message += `\nüîÑ Stage atual: ${pipeline.currentStage}`;
                    }

                    if (pipeline.error) {
                        message += `\n\n‚ùå Erro: ${pipeline.error}`;
                    }

                    alert(message);
                } else {
                    alert(`Erro: ${result.error}`);
                }
            } catch (error) {
                alert(`Erro ao obter status: ${error.message}`);
            }
        }

        // Polling de status durante execu√ß√£o
        function startStatusPolling(pipelineId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/multi-agent/status/${pipelineId}`);
                    const result = await response.json();

                    if (result.success) {
                        const pipeline = result.pipeline;

                        // Atualizar UI
                        loadPipelines();

                        // Se conclu√≠do ou erro, parar polling
                        if (pipeline.status === 'concluido' || pipeline.status === 'erro') {
                            clearInterval(interval);

                            if (pipeline.status === 'concluido') {
                                alert(`‚úÖ Pipeline ${pipelineId} conclu√≠do com sucesso!`);
                            } else {
                                alert(`‚ùå Pipeline ${pipelineId} falhou: ${pipeline.error}`);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro no polling:', error);
                }
            }, 5000); // A cada 5 segundos
        }

        // Fun√ß√µes auxiliares
        function showAlert(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function getStatusText(status) {
            const statusMap = {
                'criado': 'Criado',
                'executando': 'Executando',
                'concluido': 'Conclu√≠do',
                'erro': 'Erro'
            };
            return statusMap[status] || status;
        }

        function getModeText(mode) {
            const modeMap = {
                'automatico': 'Autom√°tico',
                'manual': 'Manual',
                'hibrido': 'H√≠brido'
            };
            return modeMap[mode] || mode;
        }

        function getBudgetText(budget) {
            const budgetMap = {
                'economico': 'Econ√¥mico',
                'premium': 'Premium',
                'flexivel': 'Flex√≠vel'
            };
            return budgetMap[budget] || budget;
        }

        function getStageIcon(stage) {
            const iconMap = {
                'leitura_massiva': 'üìö',
                'analise_profunda': 'üéØ',
                'fundamentacao': 'üß†',
                'redacao': '‚úçÔ∏è',
                'validacao': 'üíé'
            };
            return iconMap[stage] || 'üìÑ';
        }

        // Carregar pipelines ao iniciar
        loadPipelines();

        // Atualizar lista a cada 10 segundos
        setInterval(loadPipelines, 10000);
    </script>
</body>
</html>
