<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projetos - ROM Agent</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #1a365d;
      font-size: 32px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #1a365d;
    }

    .btn-danger {
      background: #f56565;
    }

    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .project-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      border-left: 5px solid;
    }

    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .project-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .project-icon {
      font-size: 32px;
    }

    .project-info h3 {
      color: #1a365d;
      font-size: 20px;
      margin-bottom: 5px;
    }

    .project-info p {
      color: #718096;
      font-size: 14px;
    }

    .project-stats {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e2e8f0;
      font-size: 14px;
      color: #718096;
    }

    .project-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .project-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .project-actions button {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #1a365d;
      font-size: 24px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #718096;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #1a365d;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 120px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .icon-picker {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .icon-option {
      font-size: 24px;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .icon-option:hover,
    .icon-option.selected {
      border-color: #667eea;
      background: #f7fafc;
    }

    .color-picker {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .color-option {
      width: 100%;
      padding-top: 100%;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: transform 0.2s;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: white;
      box-shadow: 0 0 0 2px #667eea;
    }

    .kb-files {
      list-style: none;
      margin-top: 10px;
    }

    .kb-file {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f7fafc;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .kb-file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .kb-file-name {
      font-weight: 600;
      color: #1a365d;
    }

    .kb-file-size {
      font-size: 12px;
      color: #718096;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 15px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: #1a365d;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #718096;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .projects-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .icon-picker {
        grid-template-columns: repeat(6, 1fr);
      }

      .color-picker {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        <span>üìÅ</span>
        Meus Projetos
      </h1>
      <button class="btn" onclick="openCreateModal()">
        <span>‚ûï</span>
        Novo Projeto
      </button>
    </div>

    <div id="projectsContainer" class="loading">
      Carregando projetos...
    </div>
  </div>

  <!-- Modal de Criar/Editar Projeto -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Novo Projeto</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>

      <form id="projectForm" onsubmit="saveProject(event)">
        <div class="form-group">
          <label>Nome do Projeto *</label>
          <input type="text" id="projectName" required placeholder="Ex: An√°lise de Contratos">
        </div>

        <div class="form-group">
          <label>Descri√ß√£o</label>
          <input type="text" id="projectDescription" placeholder="Breve descri√ß√£o do projeto">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>√çcone</label>
            <div class="icon-picker" id="iconPicker"></div>
          </div>

          <div class="form-group">
            <label>Cor</label>
            <div class="color-picker" id="colorPicker"></div>
          </div>
        </div>

        <div class="form-group">
          <label>Custom Instructions (Instru√ß√µes Personalizadas)</label>
          <textarea id="projectInstructions" placeholder="Instru√ß√µes espec√≠ficas para este projeto...&#10;&#10;Ex: Sempre format–µ documentos segundo ABNT..."></textarea>
        </div>

        <div class="form-group">
          <label>Knowledge Base (Arquivos)</label>
          <input type="file" id="kbFileInput" multiple>
          <ul id="kbFilesList" class="kb-files"></ul>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          <button type="submit" class="btn" style="flex: 1;">Salvar Projeto</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let projects = [];
    let currentProject = null;
    let selectedIcon = 'üìÅ';
    let selectedColor = '#667eea';

    const ICONS = ['üìÅ', '‚öñÔ∏è', 'üìÑ', 'üìä', 'üíº', 'üèõÔ∏è', 'üìù', 'üîç', 'üí°', 'üéØ', 'üìö', 'üóÇÔ∏è', 'üìã', 'üè¢', 'üë•', 'üîê'];
    const COLORS = ['#667eea', '#1a365d', '#c9a227', '#48bb78', '#ed8936', '#f56565', '#9f7aea', '#38b2ac', '#4299e1', '#ed64a6', '#ecc94b', '#fc8181'];

    // Inicializar
    async function init() {
      renderIconPicker();
      renderColorPicker();
      await loadProjects();
    }

    // Renderizar seletor de √≠cones
    function renderIconPicker() {
      const picker = document.getElementById('iconPicker');
      picker.innerHTML = ICONS.map(icon =>
        `<div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">${icon}</div>`
      ).join('');
    }

    // Renderizar seletor de cores
    function renderColorPicker() {
      const picker = document.getElementById('colorPicker');
      picker.innerHTML = COLORS.map(color =>
        `<div class="color-option ${color === selectedColor ? 'selected' : ''}" style="background-color: ${color}" onclick="selectColor('${color}')"></div>`
      ).join('');
    }

    // Selecionar √≠cone
    function selectIcon(icon) {
      selectedIcon = icon;
      renderIconPicker();
    }

    // Selecionar cor
    function selectColor(color) {
      selectedColor = color;
      renderColorPicker();
    }

    // Carregar projetos
    async function loadProjects() {
      try {
        const response = await fetch(`${API_BASE}/api/projects`);
        const data = await response.json();
        projects = data.projects || [];
        renderProjects();
      } catch (error) {
        document.getElementById('projectsContainer').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <h3>Erro ao carregar projetos</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Renderizar projetos
    function renderProjects() {
      const container = document.getElementById('projectsContainer');

      if (projects.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÅ</div>
            <h3>Nenhum projeto ainda</h3>
            <p>Crie seu primeiro projeto para organizar suas conversas e arquivos</p>
            <button class="btn" onclick="openCreateModal()">
              <span>‚ûï</span>
              Criar Primeiro Projeto
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="projects-grid">
          ${projects.map(project => `
            <div class="project-card" style="border-left-color: ${project.color}">
              <div class="project-header">
                <div class="project-icon">${project.icon}</div>
                <div class="project-info">
                  <h3>${project.name}</h3>
                  <p>${project.description || 'Sem descri√ß√£o'}</p>
                </div>
              </div>
              <div class="project-stats">
                <div class="project-stat">
                  <span>üí¨</span>
                  <span>${project.stats?.messages || 0} mensagens</span>
                </div>
                <div class="project-stat">
                  <span>üìé</span>
                  <span>${project.knowledgeBase?.length || 0} arquivos</span>
                </div>
              </div>
              <div class="project-actions">
                <button class="btn btn-secondary" onclick="openProject('${project.id}')">Abrir</button>
                <button class="btn btn-secondary" onclick="editProject('${project.id}')">Editar</button>
                ${!project.isDefault ? `<button class="btn btn-danger" onclick="deleteProject('${project.id}')">Deletar</button>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Abrir modal de cria√ß√£o
    function openCreateModal() {
      currentProject = null;
      document.getElementById('modalTitle').textContent = 'Novo Projeto';
      document.getElementById('projectForm').reset();
      selectedIcon = 'üìÅ';
      selectedColor = '#667eea';
      renderIconPicker();
      renderColorPicker();
      document.getElementById('projectModal').classList.add('active');
    }

    // Editar projeto
    async function editProject(projectId) {
      const project = projects.find(p => p.id === projectId);
      if (!project) return;

      currentProject = project;
      document.getElementById('modalTitle').textContent = 'Editar Projeto';
      document.getElementById('projectName').value = project.name;
      document.getElementById('projectDescription').value = project.description || '';
      document.getElementById('projectInstructions').value = project.customInstructions || '';
      selectedIcon = project.icon;
      selectedColor = project.color;
      renderIconPicker();
      renderColorPicker();

      // Mostrar arquivos da KB
      const kbList = document.getElementById('kbFilesList');
      kbList.innerHTML = project.knowledgeBase.map(file => `
        <li class="kb-file">
          <div class="kb-file-info">
            <span>üìé</span>
            <span class="kb-file-name">${file.name}</span>
            <span class="kb-file-size">${(file.size / 1024).toFixed(1)} KB</span>
          </div>
          <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="removeKBFile('${file.id}')">Remover</button>
        </li>
      `).join('');

      document.getElementById('projectModal').classList.add('active');
    }

    // Fechar modal
    function closeModal() {
      document.getElementById('projectModal').classList.remove('active');
      currentProject = null;
    }

    // Salvar projeto
    async function saveProject(event) {
      event.preventDefault();

      const projectData = {
        name: document.getElementById('projectName').value,
        description: document.getElementById('projectDescription').value,
        customInstructions: document.getElementById('projectInstructions').value,
        icon: selectedIcon,
        color: selectedColor
      };

      try {
        let response;
        if (currentProject) {
          // Atualizar
          response = await fetch(`${API_BASE}/api/projects/${currentProject.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData)
          });
        } else {
          // Criar
          response = await fetch(`${API_BASE}/api/projects`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData)
          });
        }

        if (!response.ok) throw new Error('Erro ao salvar projeto');

        const savedProject = await response.json();

        // Upload de arquivos KB (se houver)
        const fileInput = document.getElementById('kbFileInput');
        if (fileInput.files.length > 0) {
          for (const file of fileInput.files) {
            const formData = new FormData();
            formData.append('file', file);

            await fetch(`${API_BASE}/api/projects/${savedProject.id}/knowledge-base`, {
              method: 'POST',
              body: formData
            });
          }
        }

        closeModal();
        await loadProjects();
      } catch (error) {
        alert('Erro ao salvar projeto: ' + error.message);
      }
    }

    // Deletar projeto
    async function deleteProject(projectId) {
      if (!confirm('Tem certeza que deseja deletar este projeto?')) return;

      try {
        const response = await fetch(`${API_BASE}/api/projects/${projectId}`, {
          method: 'DELETE'
        });

        if (!response.ok) throw new Error('Erro ao deletar projeto');

        await loadProjects();
      } catch (error) {
        alert('Erro ao deletar projeto: ' + error.message);
      }
    }

    // Remover arquivo da KB
    async function removeKBFile(fileId) {
      if (!currentProject) return;

      try {
        const response = await fetch(`${API_BASE}/api/projects/${currentProject.id}/knowledge-base/${fileId}`, {
          method: 'DELETE'
        });

        if (!response.ok) throw new Error('Erro ao remover arquivo');

        await editProject(currentProject.id);
      } catch (error) {
        alert('Erro ao remover arquivo: ' + error.message);
      }
    }

    // Abrir projeto (redirecionar para chat com projeto selecionado)
    function openProject(projectId) {
      window.location.href = `/?project=${projectId}`;
    }

    // Inicializar ao carregar p√°gina
    init();
  </script>
</body>
</html>
