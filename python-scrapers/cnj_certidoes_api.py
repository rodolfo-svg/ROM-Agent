"""
IAROM - API de CertidÃµes CNJ (Plataforma de ComunicaÃ§Ãµes Processuais)
API REST oficial do CNJ para emissÃ£o de certidÃµes e consulta de publicaÃ§Ãµes DJEN

DocumentaÃ§Ã£o: https://app.swaggerhub.com/apis-docs/cnj/pcp/1.0.0
Portal DJEN: https://comunica.pje.jus.br/

IMPORTANTE: Requer credenciais do sistema Corporativo CNJ
"""

import requests
import os
from typing import Dict, List, Optional, Any
from datetime import datetime
import base64

# ConfiguraÃ§Ã£o da API
CNJ_API_CONFIG = {
    'homologacao': {
        'base_url': 'https://hcomunicaapi.cnj.jus.br/api/v1',
        'descricao': 'Ambiente de testes (homologaÃ§Ã£o)'
    },
    'producao': {
        'base_url': 'https://comunicaapi.pje.jus.br/api/v1',
        'descricao': 'Ambiente de produÃ§Ã£o'
    },
    'timeout': 60,
    'portal_djen': 'https://comunica.pje.jus.br/',
    'swagger_docs': 'https://app.swaggerhub.com/apis-docs/cnj/pcp/1.0.0'
}


class CNJCertidoesAPI:
    """Cliente para API de CertidÃµes e ComunicaÃ§Ãµes Processuais do CNJ"""

    def __init__(
        self,
        usuario: Optional[str] = None,
        senha: Optional[str] = None,
        ambiente: str = 'homologacao'
    ):
        """
        Inicializa cliente da API CNJ

        Args:
            usuario: UsuÃ¡rio do sistema Corporativo CNJ
            senha: Senha do sistema Corporativo CNJ
            ambiente: 'homologacao' ou 'producao' (padrÃ£o: homologacao)
        """
        self.usuario = usuario or os.getenv('CNJ_USUARIO')
        self.senha = senha or os.getenv('CNJ_SENHA')
        self.ambiente = ambiente

        if ambiente not in CNJ_API_CONFIG:
            raise ValueError(f"Ambiente invÃ¡lido. Use 'homologacao' ou 'producao'")

        self.base_url = CNJ_API_CONFIG[ambiente]['base_url']
        self.timeout = CNJ_API_CONFIG['timeout']

        self.session = requests.Session()
        self.session.headers.update({
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'User-Agent': 'IAROM-Extrator-Processual/1.0'
        })

        # Token de autenticaÃ§Ã£o (serÃ¡ obtido no login)
        self.token = None
        self.token_expiracao = None

    def autenticar(self) -> Dict[str, Any]:
        """
        Autentica na API CNJ

        Returns:
            Dict com status da autenticaÃ§Ã£o e token
        """
        if not self.usuario or not self.senha:
            return {
                'sucesso': False,
                'erro': 'Credenciais nÃ£o configuradas',
                'dica': 'Configure CNJ_USUARIO e CNJ_SENHA nas variÃ¡veis de ambiente'
            }

        try:
            # Endpoint de autenticaÃ§Ã£o
            url = f"{self.base_url}/auth"

            payload = {
                'usuario': self.usuario,
                'senha': self.senha
            }

            response = self.session.post(
                url,
                json=payload,
                timeout=self.timeout
            )

            response.raise_for_status()
            data = response.json()

            # Armazenar token
            self.token = data.get('token') or data.get('access_token')
            self.token_expiracao = data.get('expiracao') or data.get('expires_in')

            if self.token:
                # Adicionar token ao header
                self.session.headers.update({
                    'Authorization': f'Bearer {self.token}'
                })

                return {
                    'sucesso': True,
                    'mensagem': 'Autenticado com sucesso',
                    'ambiente': self.ambiente,
                    'token_expira_em': self.token_expiracao
                }
            else:
                return {
                    'sucesso': False,
                    'erro': 'Token nÃ£o retornado pela API',
                    'resposta': data
                }

        except requests.exceptions.HTTPError as e:
            return {
                'sucesso': False,
                'erro': f'Erro HTTP {e.response.status_code}: {e.response.text}',
                'status_code': e.response.status_code
            }
        except Exception as e:
            return {
                'sucesso': False,
                'erro': str(e)
            }

    def buscar_publicacao(
        self,
        numero_processo: str,
        data_inicio: Optional[str] = None,
        data_fim: Optional[str] = None,
        tribunal: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Busca publicaÃ§Ãµes de um processo no DJEN

        Args:
            numero_processo: NÃºmero do processo (formato CNJ)
            data_inicio: Data inÃ­cio (formato YYYY-MM-DD) - opcional
            data_fim: Data fim (formato YYYY-MM-DD) - opcional
            tribunal: CÃ³digo do tribunal (ex: 'TJSP', 'STJ') - opcional

        Returns:
            Dict com publicaÃ§Ãµes encontradas
        """
        if not self.token:
            auth_result = self.autenticar()
            if not auth_result.get('sucesso'):
                return auth_result

        try:
            url = f"{self.base_url}/comunicacao/consultar"

            # Limpar nÃºmero do processo
            numero_limpo = ''.join(filter(str.isdigit, numero_processo))

            params = {
                'numeroProcesso': numero_limpo
            }

            if data_inicio:
                params['dataInicio'] = data_inicio
            if data_fim:
                params['dataFim'] = data_fim
            if tribunal:
                params['tribunal'] = tribunal.upper()

            response = self.session.get(
                url,
                params=params,
                timeout=self.timeout
            )

            response.raise_for_status()
            data = response.json()

            return {
                'sucesso': True,
                'processo': numero_processo,
                'total_publicacoes': len(data) if isinstance(data, list) else data.get('total', 0),
                'publicacoes': data,
                'ambiente': self.ambiente
            }

        except requests.exceptions.HTTPError as e:
            return {
                'sucesso': False,
                'erro': f'Erro HTTP {e.response.status_code}: {e.response.text}',
                'status_code': e.response.status_code
            }
        except Exception as e:
            return {
                'sucesso': False,
                'erro': str(e)
            }

    def emitir_certidao(
        self,
        numero_processo: str,
        tipo_certidao: str = 'publicacao',
        formato: str = 'pdf'
    ) -> Dict[str, Any]:
        """
        Emite certidÃ£o de publicaÃ§Ã£o/recebimento

        Args:
            numero_processo: NÃºmero do processo
            tipo_certidao: Tipo ('publicacao', 'recebimento', 'inteiro_teor')
            formato: Formato do arquivo ('pdf', 'json')

        Returns:
            Dict com certidÃ£o (PDF em base64 ou JSON)
        """
        if not self.token:
            auth_result = self.autenticar()
            if not auth_result.get('sucesso'):
                return auth_result

        try:
            url = f"{self.base_url}/certidao/emitir"

            numero_limpo = ''.join(filter(str.isdigit, numero_processo))

            payload = {
                'numeroProcesso': numero_limpo,
                'tipoCertidao': tipo_certidao,
                'formato': formato
            }

            response = self.session.post(
                url,
                json=payload,
                timeout=self.timeout
            )

            response.raise_for_status()

            # Se PDF, retornar base64
            if formato.lower() == 'pdf':
                if response.headers.get('Content-Type') == 'application/pdf':
                    pdf_content = response.content
                    pdf_base64 = base64.b64encode(pdf_content).decode('utf-8')

                    return {
                        'sucesso': True,
                        'processo': numero_processo,
                        'tipo_certidao': tipo_certidao,
                        'formato': 'pdf',
                        'certidao_base64': pdf_base64,
                        'tamanho_bytes': len(pdf_content),
                        'mensagem': 'CertidÃ£o gerada com sucesso (base64)'
                    }
                else:
                    data = response.json()
                    return {
                        'sucesso': True,
                        'processo': numero_processo,
                        'certidao': data
                    }
            else:
                # JSON
                data = response.json()
                return {
                    'sucesso': True,
                    'processo': numero_processo,
                    'tipo_certidao': tipo_certidao,
                    'formato': 'json',
                    'certidao': data
                }

        except requests.exceptions.HTTPError as e:
            return {
                'sucesso': False,
                'erro': f'Erro HTTP {e.response.status_code}: {e.response.text}',
                'status_code': e.response.status_code
            }
        except Exception as e:
            return {
                'sucesso': False,
                'erro': str(e)
            }

    def consultar_comunicacao(
        self,
        id_comunicacao: str
    ) -> Dict[str, Any]:
        """
        Consulta detalhes de uma comunicaÃ§Ã£o especÃ­fica

        Args:
            id_comunicacao: ID da comunicaÃ§Ã£o

        Returns:
            Dict com detalhes da comunicaÃ§Ã£o
        """
        if not self.token:
            auth_result = self.autenticar()
            if not auth_result.get('sucesso'):
                return auth_result

        try:
            url = f"{self.base_url}/comunicacao/{id_comunicacao}"

            response = self.session.get(
                url,
                timeout=self.timeout
            )

            response.raise_for_status()
            data = response.json()

            return {
                'sucesso': True,
                'id_comunicacao': id_comunicacao,
                'comunicacao': data
            }

        except requests.exceptions.HTTPError as e:
            return {
                'sucesso': False,
                'erro': f'Erro HTTP {e.response.status_code}: {e.response.text}',
                'status_code': e.response.status_code
            }
        except Exception as e:
            return {
                'sucesso': False,
                'erro': str(e)
            }

    def listar_tribunais(self) -> Dict[str, Any]:
        """
        Lista tribunais disponÃ­veis no sistema

        Returns:
            Dict com lista de tribunais
        """
        if not self.token:
            auth_result = self.autenticar()
            if not auth_result.get('sucesso'):
                return auth_result

        try:
            url = f"{self.base_url}/tribunais"

            response = self.session.get(
                url,
                timeout=self.timeout
            )

            response.raise_for_status()
            data = response.json()

            return {
                'sucesso': True,
                'tribunais': data
            }

        except requests.exceptions.HTTPError as e:
            # Se endpoint nÃ£o existir, retornar lista padrÃ£o
            if e.response.status_code == 404:
                return {
                    'sucesso': True,
                    'mensagem': 'Endpoint de tribunais nÃ£o disponÃ­vel. Lista padrÃ£o retornada.',
                    'tribunais': self._get_tribunais_padrao()
                }

            return {
                'sucesso': False,
                'erro': f'Erro HTTP {e.response.status_code}: {e.response.text}',
                'status_code': e.response.status_code
            }
        except Exception as e:
            return {
                'sucesso': False,
                'erro': str(e)
            }

    def _get_tribunais_padrao(self) -> List[Dict[str, str]]:
        """Retorna lista padrÃ£o de tribunais"""
        return [
            {'sigla': 'STF', 'nome': 'Supremo Tribunal Federal'},
            {'sigla': 'STJ', 'nome': 'Superior Tribunal de JustiÃ§a'},
            {'sigla': 'TST', 'nome': 'Tribunal Superior do Trabalho'},
            {'sigla': 'TSE', 'nome': 'Tribunal Superior Eleitoral'},
            {'sigla': 'STM', 'nome': 'Superior Tribunal Militar'},
            {'sigla': 'TRF1', 'nome': 'TRF da 1Âª RegiÃ£o'},
            {'sigla': 'TRF2', 'nome': 'TRF da 2Âª RegiÃ£o'},
            {'sigla': 'TRF3', 'nome': 'TRF da 3Âª RegiÃ£o'},
            {'sigla': 'TRF4', 'nome': 'TRF da 4Âª RegiÃ£o'},
            {'sigla': 'TRF5', 'nome': 'TRF da 5Âª RegiÃ£o'},
            {'sigla': 'TRF6', 'nome': 'TRF da 6Âª RegiÃ£o'},
        ]

    def obter_info(self) -> Dict[str, Any]:
        """
        ObtÃ©m informaÃ§Ãµes sobre a API e configuraÃ§Ã£o

        Returns:
            Dict com informaÃ§Ãµes da API
        """
        return {
            'api': 'CNJ - Plataforma de ComunicaÃ§Ãµes Processuais',
            'versao': '1.0',
            'ambiente_atual': self.ambiente,
            'base_url': self.base_url,
            'autenticado': self.token is not None,
            'portal_djen': CNJ_API_CONFIG['portal_djen'],
            'documentacao': CNJ_API_CONFIG['swagger_docs'],
            'endpoints_disponiveis': [
                'POST /auth - AutenticaÃ§Ã£o',
                'GET /comunicacao/consultar - Buscar publicaÃ§Ãµes',
                'POST /certidao/emitir - Emitir certidÃ£o',
                'GET /comunicacao/{id} - Consultar comunicaÃ§Ã£o',
                'GET /tribunais - Listar tribunais'
            ],
            'contato_suporte': 'integracaopdpj@cnj.jus.br'
        }


# =============================================================================
# FUNÃ‡Ã•ES DE CONVENIÃŠNCIA
# =============================================================================

def emitir_certidao(
    numero_processo: str,
    tipo: str = 'publicacao',
    usuario: Optional[str] = None,
    senha: Optional[str] = None,
    ambiente: str = 'homologacao'
) -> Dict[str, Any]:
    """Emite certidÃ£o (funÃ§Ã£o de conveniÃªncia)"""
    client = CNJCertidoesAPI(usuario, senha, ambiente)
    return client.emitir_certidao(numero_processo, tipo)


def buscar_publicacao(
    numero_processo: str,
    usuario: Optional[str] = None,
    senha: Optional[str] = None,
    ambiente: str = 'homologacao'
) -> Dict[str, Any]:
    """Busca publicaÃ§Ã£o (funÃ§Ã£o de conveniÃªncia)"""
    client = CNJCertidoesAPI(usuario, senha, ambiente)
    return client.buscar_publicacao(numero_processo)


# =============================================================================
# TESTE
# =============================================================================

if __name__ == '__main__':
    print("="*80)
    print("IAROM - API de CertidÃµes CNJ (Plataforma de ComunicaÃ§Ãµes Processuais)")
    print("="*80)

    client = CNJCertidoesAPI(ambiente='homologacao')
    info = client.obter_info()

    print(f"\nğŸ“¡ API: {info['api']}")
    print(f"ğŸŒ Ambiente: {info['ambiente_atual']}")
    print(f"ğŸ”— Base URL: {info['base_url']}")
    print(f"ğŸ“š DocumentaÃ§Ã£o: {info['documentacao']}")
    print(f"ğŸŒ Portal DJEN: {info['portal_djen']}")

    print("\nğŸ“‹ Endpoints disponÃ­veis:")
    for endpoint in info['endpoints_disponiveis']:
        print(f"  â€¢ {endpoint}")

    print(f"\nâœ‰ï¸  Suporte: {info['contato_suporte']}")

    print("\nâš ï¸  CONFIGURAÃ‡ÃƒO NECESSÃRIA:")
    print("  Para usar a API, configure as variÃ¡veis de ambiente:")
    print("  - CNJ_USUARIO: UsuÃ¡rio do sistema Corporativo CNJ")
    print("  - CNJ_SENHA: Senha do sistema Corporativo CNJ")

    print("\nğŸ’¡ Exemplos de uso:")
    print("  - client.autenticar()")
    print("  - client.buscar_publicacao('0000000-00.0000.0.00.0000')")
    print("  - client.emitir_certidao('0000000-00.0000.0.00.0000', 'publicacao')")

    print("\n" + "="*80)
